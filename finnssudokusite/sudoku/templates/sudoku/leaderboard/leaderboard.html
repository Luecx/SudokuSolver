{% extends "sudoku/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}Sudoku Leaderboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'sudoku/css/leaderboard.css' %}">
{% endblock %}


{% block content %}
<div class="container mt-5">
	<h2 class="text-center title">{% trans "Leaderboard" %}</h2>

	<div class="text-center mt-4">
		<p>
			{% blocktrans with link='<a href="#" data-bs-toggle="modal" data-bs-target="#formulaModal">'|safe %}
			For a detailed explanation of how the rating is computed, {{ link }}click here</a>.
			{% endblocktrans %}
		</p>
	</div>
	
	{% if top_3|length >= 3 %}
	<div class="container onlyDesktop my-5">
		<div class="d-flex justify-content-center align-items-end" style="gap: 6px;">
			<!-- ðŸ¥ˆ Rank 2 -->
			<div class="col-3 d-flex flex-column justify-content-end">
				<div class="card text-center h-100 d-flex flex-column justify-content-end">
					<div class="card-body mt-auto">
						<h2 class="card-title">{{ top_3.1.user.username }}</h2>
						<img class="square-img mx-auto d-block" src="../../../static/sudoku/img/leaderboard/cup2.png" width="50%"/>
						<div class="text-muted small">{% trans "2nd place" %}</div>
						<div class="text-muted">{{ top_3.1.normalized_score|floatformat:2 }}</div>
					</div>
				</div>
			</div>
			<!-- ðŸ¥‡ Rank 1 -->
			<div class="col-4 d-flex flex-column justify-content-end">
				<div class="card text-center h-100 d-flex flex-column justify-content-end">
					<div class="card-body mt-auto">
						<h2 class="card-title">{{ top_3.0.user.username }}</h2>
						<img class="square-img mx-auto d-block" src="../../../static/sudoku/img/leaderboard/cup1.png" width="60%"/>
						<div class="text-muted">{% trans "1st place" %}</div>
						<div class="text-primary fw-semibold">{{ top_3.0.normalized_score|floatformat:2 }}</div>
					</div>
				</div>
			</div>
			<!-- ðŸ¥‰ Rank 3 -->
			<div class="col-3 d-flex flex-column justify-content-end">
				<div class="card text-center h-100 d-flex flex-column justify-content-end">
					<div class="card-body mt-auto">
						<h2 class="card-title">{{ top_3.2.user.username }}</h2>
						<img class="square-img mx-auto d-block" src="../../../static/sudoku/img/leaderboard/cup3.png" width="40%"/>
						<div class="text-muted small">{% trans "3rd place" %}</div>
						<div class="text-muted">{{ top_3.2.normalized_score|floatformat:2 }}</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	{% endif %}
	
	
	<div class="my_board_style p-3">
		
		<div>
			<form method="get" class="mb-4">
				<label class="form-label fw-semibold">{% trans "Search users:" %}</label>
				<div class="input-group">
					<input type="text" name="q" class="form-control" placeholder="{% trans 'Search by username...' %}" value="{{ query }}">
					<button class="btn btn-primary" type="submit">
						<span class="d-flex align-items-center">
							<i class="fa-solid fa-search"></i>
							<span class="onlyDesktop ms-2">{% trans "Search" %}</span>
						</span>
					</button>
					<button class="btn btn-danger" type="reset">
						<span class="d-flex align-items-center">
							<i class="fa-solid fa-trash-can"></i>
							<span class="onlyDesktop ms-2">{% trans "Reset" %}</span>
						</span>
					</button>
				</div>
			</form>
		</div>
		
		<div class="table-responsive">
		<table class="table table-striped table-hover align-middle">
			<thead>
			<tr>
				<th>
					<a href="?q={{ query }}&sort_by=rank&sort_order={% if sort_by == 'rank' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
						{% trans "Rank" %}
						{% if sort_by == 'rank' %}<span>{% if sort_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}
					</a>
				</th>
				<th>
					<a href="?q={{ query }}&sort_by=username&sort_order={% if sort_by == 'username' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
						{% trans "User" %}
						{% if sort_by == 'username' %}<span>{% if sort_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}
					</a>
				</th>
				<th>
					<a href="?q={{ query }}&sort_by=score&sort_order={% if sort_by == 'score' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
						{% trans "Total Score" %}
						{% if sort_by == 'score' %}<span>{% if sort_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}
					</a>
				</th>
				<th>
					<a href="?q={{ query }}&sort_by=solved&sort_order={% if sort_by == 'solved' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
						{% trans "Puzzles Solved" %}
						{% if sort_by == 'solved' %}<span>{% if sort_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}
					</a>
				</th>
			</tr>
			</thead>
			<tbody class="table-group-divider">
			{% if page_obj %}
			{% for entry in page_obj %}
			<tr>
				<td>{{ entry.rank }}</td>
				<td><a href="{% url 'user_profile' entry.user.username %}">{{ entry.user.username }}</a></td>
				<td>{{ entry.normalized_score|floatformat:2 }}</td>
				<td>{{ entry.solved }}</td>
			</tr>
			{% endfor %}
			{% else %}
			<tr>
				<td colspan="4" class="text-center text-muted">{% trans "No results yet." %}</td>
			</tr>
			{% endif %}
			</tbody>
		</table>
	</div>
	</div>
	<nav class="mt-3">
		<ul class="pagination justify-content-center">
			{% if page_obj.has_previous %}
			<li class="page-item">
				<a class="page-link" href="?q={{ query }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&page={{ page_obj.previous_page_number }}">&laquo;</a>
			</li>
			{% endif %}

			{% for num in page_obj.paginator.page_range %}
			{% if page_obj.number == num %}
			<li class="page-item active"><span class="page-link">{{ num }}</span></li>
			{% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
			<li class="page-item">
				<a class="page-link" href="?q={{ query }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&page={{ num }}">{{ num }}</a>
			</li>
			{% endif %}
			{% endfor %}

			{% if page_obj.has_next %}
			<li class="page-item">
				<a class="page-link" href="?q={{ query }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&page={{ page_obj.next_page_number }}">&raquo;</a>
			</li>
			{% endif %}
		</ul>
	</nav>

	<!-- Modal -->
	<div class="modal fade" id="formulaModal" tabindex="-1" aria-labelledby="formulaModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<div class="modal-content rounded-5">
				<div class="modal-header">
					<h5 class="modal-title w-100 text-center" id="formulaModalLabel">{% trans "How Is Your Rating Calculated?" %}</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				{% include "sudoku/leaderboard/leaderboard_explanation.html" %}
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js"></script>
<script>
	// Reset-Button: Seite ohne Filterparameter neu laden
	document.querySelector('button[type="reset"]').addEventListener("click", function (e) {
		e.preventDefault();
		window.location.href = window.location.pathname;
	});
	
	document.addEventListener("DOMContentLoaded", function () {
		renderMathInElement(document.body, {
			delimiters: [
				{left: "$$", right: "$$", display: true},
				{left: "\\[", right: "\\]", display: true},
				{left: "$", right: "$", display: false},
				{left: "\\(", right: "\\)", display: false}
			]
		});
	});
</script>
{% endblock %}
