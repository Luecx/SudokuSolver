{% extends "sudoku/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}Sudoku Leaderboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'sudoku/css/leaderboard.css' %}">
<style>
	.podest {
		width: 70%;
		margin: 0 auto;
		position: relative;
		background-image: url("{% static 'sudoku/img/leaderboard/podest.png' %}");
		background-size: contain;
		background-repeat: no-repeat;
		background-position: center;
		aspect-ratio: 1024/628;
		height: auto;
		z-index: 1;
	}
	.podest .name-1,
	.podest .pokal-1,
	.podest .box-1{
		position: absolute;
		left: 50%;
		top: 28%;
		justify-content: center;
		transform: translateX(-50%);
		display: flex;
		flex-direction: column;
	}
	
	.podest .name-2,
	.podest .pokal-2,
	.podest .box-2 {
		position: absolute;
		left: 23%;
		top: 45%;
		justify-content: center;
		transform: translateX(-50%);
		display: flex;
		flex-direction: column;
	}
	.podest .name-3,
	.podest .pokal-3,
	.podest .box-3 {
		position: absolute;
		left: 76%;
		top: 50%;
		justify-content: center;
		transform: translateX(-50%);
		display: flex;
		flex-direction: column;
	}
	
	.podest .box-1 {
		top: 40%;
		width: 26%;
		height: 45%;
	}
	.podest .box-2 {
		top: 58%;
		width: 25%;
		height: 27%;
	}
	.podest .box-3 {
		top: 63%;
		width: 26%;
		height: 22%;
	}
	.podest .pokal-1 {
		top: 6%;
		width: 22%;
	}
	.podest .pokal-2 {
		top: 33%;
		width: 16%;
	}
	.podest .pokal-3 {
		top: 42%;
		width: 14%;
	}
</style>
{% endblock %}


{% block content %}
<div class="container mt-5">
	<h2 class="text-center title">{% trans "Leaderboard" %}</h2>

	{% if top_3|length >= 3 %}
	<div class="podest">
		<!-- ðŸ¥‡ Rank 1 -->
		<div class="box-1 text-center">
			<div class="text-muted">{% trans "1st place" %}</div>
			<h2 class="card-title">{{ top_3.0.user.username }}</h2>
			<div class="text-muted">{{ top_3.0.normalized_score|floatformat:0 }}&nbsp;points</div>
		</div>
		<img class="pokal-1 square-img" src="{% static 'sudoku/img/leaderboard/cup1.png' %}"/>
		
		
		<!-- ðŸ¥ˆ Rank 2 -->
		<div class="box-2 text-center">
			<div class="text-muted">{% trans "2nd place" %}</div>
			<h2 class="card-title">{{ top_3.1.user.username }}</h2>
			<div class="text-muted">{{ top_3.1.normalized_score|floatformat:0 }}</div>
		</div>
		<img class="pokal-2 square-img" src="{% static 'sudoku/img/leaderboard/cup2.png' %}"/>
		
		<!-- ðŸ¥‰ Rank 3 -->
		<div class="box-3 text-center">
			<div class="text-muted">{% trans "3rd place" %}</div>
			<h2 class="card-title">{{ top_3.2.user.username }}</h2>
			<div class="text-muted">{{ top_3.2.normalized_score|floatformat:0 }}</div>
		</div>
		<img class="pokal-3 square-img" src="{% static 'sudoku/img/leaderboard/cup3.png' %}"/>
	</div>

	{% endif %}
	
	<div class="my_board_style p-3">
		
		<div>
			<form method="get" class="mb-4">
				<div class="input-group">
					<input type="text" name="q" class="form-control" placeholder="{% trans 'Search by username...' %}" value="{{ query }}">
					<button class="btn btn-primary" type="submit">
						<span class="d-flex align-items-center">
							<i class="fa-solid fa-search"></i>
							<span class="onlyDesktop ms-2">{% trans "Search" %}</span>
						</span>
					</button>
					<button class="btn btn-danger" type="reset">
						<span class="d-flex align-items-center">
							<i class="fa-solid fa-trash-can"></i>
							<span class="onlyDesktop ms-2">{% trans "Reset" %}</span>
						</span>
					</button>
				</div>
			</form>
		</div>
		
		<div class="table-responsive">
		<table class="table table-striped table-hover align-middle">
			<thead>
			<tr>
				<th>
					<a href="?q={{ query }}&sort_by=rank&sort_order={% if sort_by == 'rank' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
						{% trans "Rank" %}
						{% if sort_by == 'rank' %}<span>{% if sort_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}
					</a>
				</th>
				<th>
					<a href="?q={{ query }}&sort_by=username&sort_order={% if sort_by == 'username' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
						{% trans "User" %}
						{% if sort_by == 'username' %}<span>{% if sort_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}
					</a>
				</th>
				<th>
					<a href="?q={{ query }}&sort_by=score&sort_order={% if sort_by == 'score' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
						{% trans "Total Score" %}
						{% if sort_by == 'score' %}<span>{% if sort_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}
					</a>
				</th>
				<th>
					<a href="?q={{ query }}&sort_by=solved&sort_order={% if sort_by == 'solved' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
						{% trans "Puzzles Solved" %}
						{% if sort_by == 'solved' %}<span>{% if sort_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}
					</a>
				</th>
			</tr>
			</thead>
			<tbody class="table-group-divider">
			{% if page_obj %}
			{% for entry in page_obj %}
			<tr>
				<td>{{ entry.rank }}</td>
				<td><a href="{% url 'user_profile' entry.user.username %}">{{ entry.user.username }}</a></td>
				<td>{{ entry.normalized_score|floatformat:0 }}</td>
				<td>{{ entry.solved }}</td>
			</tr>
			{% endfor %}
			{% else %}
			<tr>
				<td colspan="4" class="text-center text-muted">{% trans "No results yet." %}</td>
			</tr>
			{% endif %}
			</tbody>
		</table>
	</div>
	</div>
	<div class="text-center mt-4">
		<p>
			{% blocktrans with link='<a href="#" data-bs-toggle="modal" data-bs-target="#formulaModal">'|safe %}
			For a detailed explanation of how the rating is computed, {{ link }}click here</a>.
			{% endblocktrans %}
		</p>
	</div>
	<nav class="mt-3">
		<ul class="pagination justify-content-center">
			{% if page_obj.has_previous %}
			<li class="page-item">
				<a class="page-link" href="?q={{ query }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&page={{ page_obj.previous_page_number }}">&laquo;</a>
			</li>
			{% endif %}

			{% for num in page_obj.paginator.page_range %}
			{% if page_obj.number == num %}
			<li class="page-item active"><span class="page-link">{{ num }}</span></li>
			{% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
			<li class="page-item">
				<a class="page-link" href="?q={{ query }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&page={{ num }}">{{ num }}</a>
			</li>
			{% endif %}
			{% endfor %}

			{% if page_obj.has_next %}
			<li class="page-item">
				<a class="page-link" href="?q={{ query }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&page={{ page_obj.next_page_number }}">&raquo;</a>
			</li>
			{% endif %}
		</ul>
	</nav>

	<!-- Modal -->
	<div class="modal fade" id="formulaModal" tabindex="-1" aria-labelledby="formulaModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<div class="modal-content rounded-5">
				<div class="modal-header">
					<h5 class="modal-title w-100 text-center" id="formulaModalLabel">{% trans "How Is Your Rating Calculated?" %}</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				{% include "sudoku/leaderboard/leaderboard_explanation.html" %}
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js"></script>
<script>
	// Reset-Button: Seite ohne Filterparameter neu laden
	document.querySelector('button[type="reset"]').addEventListener("click", function (e) {
		e.preventDefault();
		window.location.href = window.location.pathname;
	});
	
	document.addEventListener("DOMContentLoaded", function () {
		renderMathInElement(document.body, {
			delimiters: [
				{left: "$$", right: "$$", display: true},
				{left: "\\[", right: "\\]", display: true},
				{left: "$", right: "$", display: false},
				{left: "\\(", right: "\\)", display: false}
			]
		});
	});
</script>
{% endblock %}
