{% load form_filters %}
{% load i18n %}
{% load static %}
{% load widget_tweaks %}

<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content border rounded-5 shadow-sm">
			<div id="modalContentContainer" class="modal-body p-4">
				<h3 class="card-title text-center mb-4">Login</h3>
				<form id="loginForm" method="post" action="{% url 'modal_login' %}" novalidate data-ajax="true">
					{% csrf_token %}
					{% if login_form.non_field_errors %}
					<div class="alert alert-danger">
						{{ login_form.non_field_errors }}
					</div>
					{% endif %}
					
					{% for field in login_form %}
					<div class="mb-2">
						{% if field.name == "username" %}
						<label for="{{ field.id_for_label }}" class="form-label m-0">{% trans "Username or Email" %}</label>
						{% else %}
						<label for="{{ field.id_for_label }}" class="form-label m-0">{{ field.label }}</label>
						{% endif %}
						{{ field|add_class:"form-control" }}
						{% if field.help_text %}
						<div class="form-text">{{ field.help_text }}</div>
						{% endif %}
						{% for error in field.errors %}
						<div class="invalid-feedback d-block">{{ error }}</div>
						{% endfor %}
					</div>
					{% endfor %}
					
					<button type="submit" class="btn btn-primary w-100 mt-2">{% trans "Log In" %}</button>
				</form>
				<div class="col-auto d-flex justify-content-center mt-2">
					<button class="btn btn-link my-text-btn" data-bs-toggle="modal" data-bs-target="#passwordresetModal" data-bs-dismiss="modal">{% trans "Forgot your password?" %}</button>
				</div>
				<hr class="my-4">
				
				
				
				<div class="d-flex align-items-center justify-content-center gap-3 mt-2">
					<span class="text-nowrap">{% trans "Sign in with..." %}</span>
					<a href="{#% url 'socialaccount_login' 'google' %#}">
						<img src="{% static 'sudoku/img/login/loginSign-google.svg' %}" alt="Google" width="30" class="me-2">
					</a>
				</div>
				<div class="text-center mt-3">
					<button class="btn btn-link m-0 p-0 link link--io my-text-btn" data-bs-toggle="modal" data-bs-target="#registerModal" data-bs-dismiss="modal">{% trans "No account yet? Register now" %}</button>
				</div>
			</div>
			<script>
			function bindLoginFormHandler() {
				const loginForm = document.getElementById("loginForm");
				if (!loginForm || loginForm.dataset.bound === "true") return;
				loginForm.dataset.bound = "true"; // Doppelte Bindung verhindern

				loginForm.addEventListener("submit", async function (e) {
					e.preventDefault(); // verhindert Seitensprung
					const formData = new FormData(loginForm);

					const response = await fetch(loginForm.action, {
						method: "POST",
						body: formData,
						headers: {
							"X-Requested-With": "XMLHttpRequest"
						}
					});

					const contentType = response.headers.get("content-type") || "";

					if (contentType.includes("application/json")) {
						const data = await response.json();
						if (data.success) {
							bootstrap.Modal.getInstance(document.getElementById("loginModal"))?.hide();
							window.location.reload(); // oder weiterleiten
						} else {
							showLoginErrors(data.errors);
						}
					} else {
						const html = await response.text();
						document.getElementById("modalContentContainer").innerHTML = html;
						bindLoginFormHandler(); // nach Austausch neu binden
					}
				});
			}

			function showLoginErrors(errors) {
				const errorContainer = document.getElementById("loginErrors");
				if (!errorContainer) return;
				errorContainer.innerHTML = "";
				for (const [field, messages] of Object.entries(errors)) {
					messages.forEach(msg => {
						const div = document.createElement("div");
						div.className = "alert alert-danger py-1 mb-1";
						div.textContent = msg.message;
						errorContainer.appendChild(div);
					});
				}
			}

			document.addEventListener("DOMContentLoaded", bindLoginFormHandler);
			document.getElementById("loginModal")?.addEventListener("shown.bs.modal", () => {
				requestAnimationFrame(bindLoginFormHandler);
			});
			</script>
		</div>
	</div>
</div>
