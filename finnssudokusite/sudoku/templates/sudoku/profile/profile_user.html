<!-- profile_user.html -->
{% load form_filters %}
{% load widget_tweaks %}
{% load i18n %}

<div class="card border-0">
	<div class="card-body">
		<h3 class="card-title text-center mb-4">{% trans "Your profile" %}</h3>
		
		<!-- User Info -->
		<div class="mb-4">
			<label class="form-label">{% trans "User name" %}</label>
			<div class="position-relative">
				<input type="text" class="form-control" value="{{ request.user.username }}" disabled>
				<a href="#" class="position-absolute top-50 end-0 translate-middle-y me-3 text-decoration-none" style="font-size: 1.5rem;">
					<i class="bi bi-pencil"></i>
				</a>
			</div>
		</div>
		<div class="mb-5">
			<label class="form-label">Email</label>
			<div class="position-relative">
				<input type="text" class="form-control" value="{{ request.user.email }}" disabled>
				<a href="#" class="position-absolute top-50 end-0 translate-middle-y me-3 text-decoration-none" style="font-size: 1.5rem;">
					<i class="bi bi-pencil"></i>
				</a>
			</div>
		</div>
		
		<!-- Password Change  - Button open the Modal -->
		<div class="text-center mb-3">
			<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#password_change" id="openPasswordModal">
				{% trans "Change password" %}
			</button>
		</div>
		<!-- Modal -->
		<div class="modal fade" id="password_change" tabindex="-1" aria-labelledby="passwordChangeLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content p-3">
					
					<!-- Modal Header -->
					<div class="modal-header">
						<h5 class="modal-title" id="passwordChangeLabel">{% trans "Change password" %}</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Schließen' %}"></button>
					</div>
					
					<!-- Modal Body mit Formular -->
					<div id="changePWFormContainer" class="modal-body py-3">
						{% include "sudoku/profile/change_pw_form.html" %}
					</div>
				
				</div>
			</div>
		</div>
	
	</div>
</div>

{% if form.errors %}
<script>
	document.addEventListener("DOMContentLoaded", function () {
		var myModal = new bootstrap.Modal(document.getElementById('password_change'));
		myModal.show();
	});
</script>
{% endif %}

<script>
	document.addEventListener("DOMContentLoaded", function() {
		const passwordInput = document.querySelector('#id_new_password1');
		const strengthBar = document.getElementById('passwordStrengthBar');
		const strengthText = document.getElementById('passwordStrengthText');
		
		if (passwordInput) {
			passwordInput.addEventListener('input', function() {
				const val = passwordInput.value;
				const result = checkPasswordStrength(val);
				strengthBar.style.width = result.percent + '%';
				strengthBar.className = 'progress-bar bg-' + result.color;
				strengthText.textContent = result.message;
			});
		}
		
		// AJAX-Formular-Submit
		const form = document.querySelector('#passwordChangeForm');
		if (form) {
			form.addEventListener('submit', function(e) {
				e.preventDefault();
				fetch(form.action, {
					method: 'POST',
					body: new FormData(form),
					headers: {
						'X-Requested-With': 'XMLHttpRequest'
					}
				})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							// Erfolg: Modal schließen und ggf. Meldung anzeigen
							var modal = bootstrap.Modal.getInstance(document.getElementById('password_change'));
							modal.hide();
							// Hier kannst du eine Erfolgsmeldung anzeigen, z.B. mit Toast
							alert(data.message);
						} else {
							// Fehler: Formular aktualisieren
							document.getElementById('changePWFormContainer').innerHTML = data.html;
							// Passwortstärke-Listener wieder setzen
							const newPasswordInput = document.querySelector('#id_new_password1');
							if (newPasswordInput) {
								newPasswordInput.addEventListener('input', function() {
									const val = newPasswordInput.value;
									const result = checkPasswordStrength(val);
									strengthBar.style.width = result.percent + '%';
									strengthBar.className = 'progress-bar bg-' + result.color;
									strengthText.textContent = result.message;
								});
							}
						}
					})
					.catch(error => {
						console.error('Error:', error);
					});
			});
		}
		
		function checkPasswordStrength(password) {
			const minLength = 8;
			let strength = 0;
			
			const patterns = [
				/[a-z]/,         // Kleinbuchstaben
				/[A-Z]/,         // Großbuchstaben
				/\d/,            // Zahlen
				/[^A-Za-z0-9]/   // Sonderzeichen
			];
			
			patterns.forEach(pattern => {
				if (pattern.test(password)) strength++;
			});
			
			// Mindestlänge prüfen
			if (password.length < minLength) {
				return {
					percent: 10,
					color: 'danger',
					message: 'Zu kurz (min. 8 Zeichen)'
				};
			}
			switch (strength) {
				case 0:
				case 1:
					return {percent: 25, color: 'danger', message: 'Very weak'};
				case 2:
					return {percent: 50, color: 'warning', message: 'Weak'};
				case 3:
					return {percent: 75, color: 'info', message: 'Good'};
				case 4:
					return {percent: 100, color: 'success', message: 'Very strong'};
			}
		}
	});
</script>