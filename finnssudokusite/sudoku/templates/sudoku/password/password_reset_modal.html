{% load form_filters %}
{% load i18n %}
{% load static %}
{% load widget_tweaks %}

<div class="modal fade" id="passwordResetModal" tabindex="-1" aria-labelledby="passwordResetModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content border rounded-5 shadow-sm">
			<div id="modalContentContainer" class="modal-body p-4">
				
				<h3 class="card-title text-center mb-4">{% trans "Reset Your Password" %}</h3>
				<form method="post" action="{% url 'modal_reset' %}">
					{% csrf_token %}
					
					{% for error in form.non_field_errors %}
					<div class="alert alert-danger py-1 mb-1">{{ error }}</div>
					{% endfor %}
					
					<label for="{{ form.email.id_for_label }}" class="form-label">
						{{ form.email.label }}
					</label>
					{{ form.email|add_class:"form-control" }}
					{% for error in form.email.errors %}
					<div class="invalid-feedback d-block">{{ error }}</div>
					{% endfor %}
					
					<button type="submit" class="btn btn-primary w-100 mt-3">{% trans "Send reset link" %}</button>
				</form>
				
				<div class="col-auto d-flex justify-content-center mt-2">
					<button class="btn btn-link m-0 p-0 link link--io my-text-btn" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-dismiss="modal">{% trans "Back to Login" %}</button>
				</div>
			</div>
		</div>
	</div>
<script>
function bindResetFormHandler() {
	const form = document.querySelector("#passwordResetModal form");
	if (!form || form.dataset.bound === "true") return;
	form.dataset.bound = "true";

	form.addEventListener("submit", async function (e) {
		e.preventDefault();

		try {
			const response = await fetch(form.action, {
				method: "POST",
				body: new FormData(form),
				headers: { "X-Requested-With": "XMLHttpRequest" },
				credentials: "same-origin"
			});

			const contentType = response.headers.get("content-type") || "";
			if (contentType.includes("application/json")) {
				const data = await response.json();
				if (data.success) {
					bootstrap.Modal.getInstance(document.getElementById("passwordResetModal"))?.hide();
					alert("Falls die E-Mail-Adresse existiert, wurde eine E-Mail gesendet.");
				} else if (data.html) {
					document.getElementById("passwordResetModal").outerHTML = data.html;
					requestAnimationFrame(bindResetFormHandler);
				}
			} else {
				const html = await response.text();
				document.getElementById("passwordResetModal").outerHTML = html;
				requestAnimationFrame(bindResetFormHandler);
			}
		} catch (err) {
			console.error("Fehler beim ZurÃ¼cksetzen des Passworts:", err);
		}
	});
}

document.addEventListener("DOMContentLoaded", bindResetFormHandler);
document.getElementById("passwordResetModal")?.addEventListener("shown.bs.modal", () => {
	requestAnimationFrame(bindResetFormHandler);
});
</script>
</div>

