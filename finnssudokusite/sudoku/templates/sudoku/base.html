{% load form_filters %}
{% load i18n %}
{% load static %}
{% load widget_tweaks %}

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>{% block title %}Sudoku{% endblock %}</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="csrf-token" content="{{ csrf_token }}">
	<link rel="shortcut icon" href="{% static 'icons/favicon.ico' %}" type="image/x-icon">
	<link rel="apple-touch-icon" sizes="180x180" href="{% static 'icons/apple-touch-icon.png' %}">
	<link rel="apple-touch-icon-precomposed" sizes="180x180" href="{% static 'icons/apple-touch-icon-precomposed.png' %}">
	
	<!-- Bootstrap -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
	
	<!-- Font Awesome -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
	<link rel="stylesheet" href="{% static 'sudoku/css/style.css' %}">
	<link rel="stylesheet" href="{% static 'sudoku/css/style-menu.css' %}">

	<script src="{% url 'javascript-catalog' %}"></script>

	{% block extra_css %}
	{% endblock %}

</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg " style="z-index: 1000">
	<div class="container-fluid">
		<a class="navbar-brand" href="/">
			<img src="{% static 'sudoku/img/brain-white-32.png' %}" alt="Logo" width="32" height="32" class="align-middle me-2">SudokuSphere</a>
		<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
			<span class="navbar-toggler-icon"></span>
		</button>
		
		<div class="collapse navbar-collapse" id="navbarNav">
			<ul class="navbar-nav me-auto mb-2 mb-lg-0">
				<li class="nav-item">
					<a class="nav-link" href="{% url 'game_selection' %}">
						<i class="bi bi-emoji-smile me-2"></i>{% trans "Play" %}
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="{% url 'puzzles' %}">
						<i class="fas fa-th-list me-2"></i>{% trans "Sudokus" %}
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="{% url 'leaderboard' %}">
						<i class="fas fa-trophy me-2"></i>{% trans "Leaderboards" %}
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="{% url 'creator' %}">
						<i class="fas fa-pencil-alt me-2"></i>{% trans "Sudoku Creator" %}
					</a>
				</li>
			</ul>
			
			<ul class="navbar-nav ms-auto">
				
				<!-- language-picker-modal -->
				{% get_current_language as LANGUAGE_CODE %}
				<li class="nav-item">
					<a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#language-picker-modal" role="button">
						<i class="fas fa-globe me-2"></i><span id="currentLang"></span>
					</a>
				</li>
				
				<!-- USER -->
				{% if user.is_authenticated %}
				<li class="nav-item dropdown">
					<a class="nav-link" id="userDropdown" href="{% url 'profile' %}" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user"></i></a>
					
					<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
						<li>
							<span class="nav-dropdowntext mx-3">{{ user.username }}</span>
						</li>
						<hr>
						<li>
							<a class="dropdown-item" href="{% url 'profile' %}#profile"><i class="fas fa-user me-2"></i>{% trans "Your profile" %}</a>
						</li>
						<li>
							<a class="dropdown-item" href="{% url 'profile' %}#done"><i class="bi bi-check-lg me-2"></i>{% trans "Sudokus done" %}</a>
						</li>
						<li>
							<a class="dropdown-item" href="{% url 'profile' %}#ongoing"><i class="bi bi-arrow-right me-2"></i>{% trans "Ongoing Sudokus" %}</a>
						</li>
						<li>
							<a class="dropdown-item" href="{% url 'profile' %}#created"><i class="bi bi-grid-3x3 me-2"></i>{% trans "Sudokus Created" %}</a>
						</li>
						<hr>
						<li>
							<form method="post" action="{% url 'logout' %}" class="m-0">
								{% csrf_token %}
								<button type="submit" class="dropdown-item">
									<i class="fas fa-sign-out-alt me-2"></i>{% trans "Logout" %}
								</button>
							</form>
						</li>
					</ul>
				</li>
				{% else %}
				<li class="nav-item">
					<button class="navbar-link btn btn-link my-text-btn" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-dismiss="modal">{% trans "Login" %}</button>
				</li>
				{% endif %}
			</ul>
			
		</div>
	</div>
</nav>

<!-- Main content -->
{% block container %}
<div class="container mt-4">
	{% block content %}{% endblock %}
</div>
{% endblock %}

<!-- Modal -->
{% include "sudoku/login/login.html" %}
{% include "sudoku/login/register_modal.html" %}
{% include "sudoku/password/password_reset_modal.html" %}



<script>
	const currentLang = "{{ LANGUAGE_CODE|default:'en' }}";
	localStorage.setItem("preferredLanguage", currentLang);
</script>
<!-- language picker Modal -->
{% include "sudoku/modal_language_picker.html" %}
<script>
	const currentLangSpan = document.getElementById('currentLang');
	if (currentLangSpan && languages[currentLang]) {
		currentLangSpan.textContent = languages[currentLang].n;
	}
</script>


<!-- Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% block extra_scripts %}

<!--  Script for Login Modal  -->
<script>
	function bindLoginFormHandler() {
		const loginForm = document.getElementById("loginForm");
		const modalContent = document.getElementById("modalContentContainer") || document.getElementById("loginFormContainer");
		const errorContainer = document.getElementById("loginErrors");
		if (!loginForm || !modalContent) return;
		console.log("Login-Form gebunden");
		
		loginForm.addEventListener("submit", async (e) => {
			e.preventDefault();
			
			const formData = new FormData(loginForm);
			
			try {
				const response = await fetch(loginForm.action, {
					method: loginForm.method,
					body: formData,
					headers: {
						"X-Requested-With": "XMLHttpRequest"
					}
				});
				
				const text = await response.text();
				
				let data;
				try {
					data = JSON.parse(text);
					console.log("Login response", data);
				} catch {
					data = null;
				}
				
				if (data && data.success) {
					const modalInstance = bootstrap.Modal.getInstance(document.getElementById("loginModal"));
					modalInstance?.hide();
					document.body.classList.remove("modal-open");
					document.querySelectorAll(".modal-backdrop").forEach(el => el.remove());
					if (data.redirect_url) {
						window.location.href = data.redirect_url;
					} else {
						window.location.reload();
					}
				} else {
					if (errorContainer) {
						errorContainer.innerHTML = "";
						loginForm.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));
						if (data && data.errors) {
							for (const [field, errorList] of Object.entries(data.errors)) {
								errorList.forEach(err => {
									const div = document.createElement("div");
									div.classList.add("alert", "alert-danger", "py-1", "mb-1");
									div.textContent = err.message;
									errorContainer.appendChild(div);
								});
								const fieldEl = loginForm.querySelector(`[name="${field}"]`);
								if (fieldEl) {
									fieldEl.classList.add("is-invalid");
								}
							}
						}
					} else {
						modalContent.innerHTML = text;
					}
				}
			} catch (error) {
				console.error("Fehler beim Login-Request:", error);
				modalContent.innerHTML = '<div class="alert alert-danger">Fehler beim Senden des Formulars. Bitte versuche es erneut.</div>';
			}
		});
	}
	
	// Fallback-Funktion, die wiederholt prüft, ob das Formular verfügbar ist
	function initLoginHandler() {
		const form = document.getElementById("loginForm");
		if (!form) {
			console.warn("LoginForm nicht gefunden – versuche später erneut");
			setTimeout(initLoginHandler, 300);
			return;
		}
		bindLoginFormHandler();
	}
	window.addEventListener("load", initLoginHandler);
	
	// Modal-Wechsel: Erst anderes Modal schließen, dann öffnen
	document.querySelector('[data-bs-target="#loginModal"]')?.addEventListener("click", (e) => {
		const registerModal = bootstrap.Modal.getInstance(document.getElementById("registerModal"));
		registerModal?.hide();
		setTimeout(() => {
			const loginModal = new bootstrap.Modal(document.getElementById("loginModal"));
			loginModal.show();
		}, 300);
	});
	document.querySelector('[data-bs-target="#registerModal"]')?.addEventListener("click", (e) => {
		const loginModal = bootstrap.Modal.getInstance(document.getElementById("loginModal"));
		loginModal?.hide();
		setTimeout(() => {
			const registerModal = new bootstrap.Modal(document.getElementById("registerModal"));
			registerModal.show();
		}, 300);
	});
	
<!--  Script for Register Modal  -->
	function bindRegisterFormHandler() {
		const form = document.querySelector("#registerModal form");
		if (!form) return;

		form.addEventListener("submit", async function (e) {
			e.preventDefault();

			try {
				const response = await fetch(form.action, {
					method: "POST",
					body: new FormData(form),
					headers: { "X-Requested-With": "XMLHttpRequest" }
				});
				const text = await response.text();

				let data = null;
				try { data = JSON.parse(text); } catch (_) {}

				if (data && data.success) {
					bootstrap.Modal.getInstance(document.getElementById("registerModal"))?.hide();
					alert("Bitte bestätige deine Registrierung per E-Mail.");
				} else {
					const container = document.getElementById("registerFormContainer");
					if (container) {
						container.innerHTML = text;
						requestAnimationFrame(bindRegisterFormHandler);
					} else {
						console.error("registerFormContainer not found – kann Formular nicht aktualisieren");
					}
				}
			} catch (err) {
				console.error("Fehler beim Registrieren:", err);
			}
		});
	}

	document.addEventListener("DOMContentLoaded", bindRegisterFormHandler);
	
	const registerModalEl = document.getElementById("registerModal");
	registerModalEl?.addEventListener("shown.bs.modal", () => {
		requestAnimationFrame(bindRegisterFormHandler);
	});
</script>


<!--  Script for Password Reset Modal  -->


{% endblock %}


</body>
</html>
